<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار اللغة الإنجليزية - الصف الثاني الإعدادي</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* أنماط عامة */
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        /* الحاوية الرئيسية */
        .exam-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        
        /* رأس الامتحان */
        .exam-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #007bff;
        }
        
        .exam-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        /* إحصائيات الأسئلة */
        .stats {
            background: #e9f5ff;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
            border-right: 4px solid #007bff;
        }
        
        /* الأسئلة */
        .question {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #fafafa;
            transition: all 0.3s ease;
        }
        
        .question:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .question h3 {
            color: #007bff;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }
        
        /* النصوص والقصائد */
        .passage, .poem {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            line-height: 1.8;
            font-style: italic;
            border-right: 4px solid #6c757d;
        }
        
        .poem {
            text-align: center;
            font-weight: bold;
            background: #fff9e6;
            border-right-color: #ffc107;
        }
        
        /* خيارات الأسئلة */
        .options {
            margin: 20px 0;
        }
        
        .option {
            margin-bottom: 10px;
            padding: 12px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
            background: white;
        }
        
        .option:hover {
            background-color: #e9f5ff;
            transform: translateX(-5px);
        }
        
        .option.selected {
            background-color: #d4edff;
            border-left: 4px solid #007bff;
        }
        
        .option.correct {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .option.incorrect {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        
        /* شرح الإجابة */
        .explanation {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-right: 3px solid #6c757d;
        }
        
        /* حقول الإدخال */
        .fill-in-blank input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .fill-in-blank input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        /* التنقل بين الأسئلة */
        .navigation {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
        }
        
        /* الأزرار */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #0069d9;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background-color: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background-color: #218838;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background-color: #c82333;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover:not(:disabled) {
            background-color: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-info:hover:not(:disabled) {
            background-color: #138496;
            transform: translateY(-2px);
        }
        
        /* النتائج */
        .results-container {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .score {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
            color: #007bff;
        }
        
        .feedback {
            text-align: center;
            font-size: 18px;
            margin: 15px 0;
            color: #28a745;
            font-weight: bold;
        }
        
        .result-item {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .recommendations {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ffeaa7;
        }
        
        .correct-answer {
            color: #28a745;
            font-weight: bold;
        }
        
        /* عناصر التحكم */
        .controls {
            margin-top: 30px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* التكيف مع الشاشات الصغيرة */
        @media (max-width: 768px) {
            .exam-container {
                padding: 15px;
            }
            
            .navigation {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .question {
                padding: 15px;
            }
            
            .passage, .poem {
                padding: 15px;
            }
        }
    </style></head>
<body>
    <div class="exam-container">
        <div class="exam-header">
            <h1 id="exam-title">اختبار اللغة الإنجليزية - الصف الثاني الإعدادي (Unit 1) - الترم الأول</h1>
        </div>
        
        <div class="stats">السؤال <span id="current-question">1</span> من <span id="total-questions">30</span></div>
        
        <div id="questions-container"></div>
        
        <div class="navigation">
            <button id="prev-btn" class="btn btn-secondary" disabled>السابق</button>
            <button id="next-btn" class="btn btn-primary">التالي</button>
        </div>
        
        <div class="controls">
            <button id="restart-btn" class="btn btn-warning">إعادة البدء</button>
            <button id="print-btn" class="btn btn-info">طباعة النتائج</button>
            <button id="share-btn" class="btn btn-success">مشاركة النتائج</button>
            <button id="back-btn" class="btn btn-danger">العودة للامتحانات</button>
        </div>
        
        <div class="results-container" id="results-container">
            <h2>النتيجة</h2>
            <div id="score"></div>
            <div id="detailed-results"></div>
        </div>
    </div>

    <audio id="correctSound" src="../../../assets/audio/correct.mp3" preload="auto"></audio>
    <audio id="incorrectSound" src="../../../assets/audio/incorrect.mp3" preload="auto"></audio>


   <script>
    // أصوات
    const correctSound = document.getElementById('correctSound');
    const incorrectSound = document.getElementById('incorrectSound');

    // معرف الامتحان
    const examId = "arabic-grade1-term1";

    // بيانات الأسئلة (كما أرسلتها)
    const examData = {
        title: "اختبار اللغة الإنجليزية - الصف الثاني الإعدادي (Unit 1) - الترم الأول",
        questions: [
            {
        "id": 1,
        "type": "multiple-choice",
        "text": "Mariam's routine is every day.",
        "options": [
            { "id": 1, "text": "the same", "correct": true },
            { "id": 2, "text": "different", "correct": false },
            { "id": 3, "text": "difficult", "correct": false },
            { "id": 4, "text": "funny", "correct": false }
        ],
        "explanation": "كلمة \"routine\" تعني روتين، أي نشاط يومي مكرر → إذًا يكون \"the same\" (متماثل كل يوم)."
    },
    {
        "id": 2,
        "type": "multiple-choice",
        "text": "Mariam has a friend called.",
        "options": [
            { "id": 1, "text": "Mariam", "correct": false },
            { "id": 2, "text": "Ahmed", "correct": false },
            { "id": 3, "text": "ignoble", "correct": false },
            { "id": 4, "text": "Basant", "correct": true }
        ],
        "explanation": "لا يمكن أن يكون اسم الصديق \"Mariam\" (نفسها)، و\"ignoble\" تعني \"حقر\"، وليست اسمًا. \"Basant\" اسم شائع ومقنع."
    },
    {
        "id": 3,
        "type": "multiple-choice",
        "text": "She goes to school by.",
        "options": [
            { "id": 1, "text": "train", "correct": false },
            { "id": 2, "text": "bus", "correct": true },
            { "id": 3, "text": "car", "correct": false },
            { "id": 4, "text": "plane", "correct": false }
        ],
        "explanation": "الأكثر منطقية لذهاب التلميذ إلى المدرسة في مصر هو الحافلة (bus)، وليس الطائرة أو القطار."
    },
    {
        "id": 4,
        "type": "multiple-choice",
        "text": "Mariam and her friend sometimes...",
        "options": [
            { "id": 1, "text": "walk", "correct": false },
            { "id": 2, "text": "listen to music", "correct": true },
            { "id": 3, "text": "sleep", "correct": false },
            { "id": 4, "text": "swim", "correct": false }
        ],
        "explanation": "من السلوكيات الشائعة بين الأصدقاء، وتناسب السياق المدرسي."
    },
    {
        "id": 5,
        "type": "fill-in-blank",
        "text": "Waiter: How can I help you? Ali: I want to (1).... my lunch.",
        "correctAnswer": "order",
        "explanation": "I want to order my lunch."
    },
    {
        "id": 6,
        "type": "fill-in-blank",
        "text": "Waiter: Ok, Sir. (2).... What would you like to have?",
        "correctAnswer": "Please",
        "explanation": "Ok, Sir. Please, what would you like to have?"
    },
    {
        "id": 7,
        "type": "fill-in-blank",
        "text": "Ali: I would like to have fish. Waiter: Yes, I want (3)....",
        "correctAnswer": "that",
        "explanation": "Yes, I want that."
    },
    {
        "id": 8,
        "type": "fill-in-blank",
        "text": "Ali: Ok. That is fish, rice and a salad. And a salad. Ali: Yes, How (4)... ...are they?",
        "correctAnswer": "much",
        "explanation": "How much are they?"
    },
    {
        "id": 9,
        "type": "fill-in-blank",
        "text": "Waiter: They are 120 Egyptian (5)...",
        "correctAnswer": "pounds",
        "explanation": "They are 120 Egyptian pounds."
    },
    {
"id": 10,
"type": "passage",
"content": "I'm Hassan. My family lives in Alexandria, but my dad doesn't work in Egypt. He works in England. He went to the airport on Sunday evenings and he caught the plane to England. He will come home next month. On Saturday, I don't go to school, and my brother doesn't go to school as well. We play chess or go to the park. On Sunday mornings, we go swimming. My sister is three and she doesn't swim. She watches us. I hope to travel to England when I grow up to complete my study there. My father encourages me to do that."
},
    {
        "id": 11,
        "type": "fill-in-blank",
        "text": "Where does Hassan's father work?",
        "correctAnswer": "He works in England.",
        "explanation": "ورد في النص: \"He works in England.\""
    },
    {
        "id": 12,
        "type": "fill-in-blank",
        "text": "Give a suitable title for the passage.",
        "correctAnswer": "My Family and I أو Hassan's Life and Dreams",
        "explanation": "النص يتحدث عن حياة حسن، أسرته، وطموحه."
    },
    {
        "id": 13,
        "type": "fill-in-blank",
        "text": "How long will Hassan's father stay in England?",
        "correctAnswer": "He will stay until next month.",
        "explanation": "\"He will come home next month\" → إذًا سيظل في إنجلترا حتى الشهر القادم."
    },
    {
        "id": 14,
        "type": "multiple-choice",
        "text": "The underlined pronoun \"She\" refers to.....",
        "options": [
            { "id": 1, "text": "Hassan", "correct": false },
            { "id": 2, "text": "Hassan's father", "correct": false },
            { "id": 3, "text": "Hassan's sister", "correct": true },
            { "id": 4, "text": "Hassan's family", "correct": false }
        ],
        "explanation": "\"My sister is three and she doesn't swim\" → الضمير \"she\" يعود على \"sister\"."
    },
    {
        "id": 15,
        "type": "multiple-choice",
        "text": "When do they go to the park?",
        "options": [
            { "id": 1, "text": "On Sunday", "correct": false },
            { "id": 2, "text": "On Saturday", "correct": true },
            { "id": 3, "text": "Everyday", "correct": false },
            { "id": 4, "text": "On Wednesday", "correct": false }
        ],
        "explanation": "\"On Saturday, we play chess or go to the park.\""
    },
    {
        "id": 16,
        "type": "multiple-choice",
        "text": "Hassan hopes to travel to....",
        "options": [
            { "id": 1, "text": "France", "correct": false },
            { "id": 2, "text": "England", "correct": true },
            { "id": 3, "text": "China", "correct": false },
            { "id": 4, "text": "KSA", "correct": false }
        ],
        "explanation": "\"I hope to travel to England when I grow up.\""
    },
    {
        "id": 17,
        "type": "multiple-choice",
        "text": "My ___ routine starts at 7 a.m.",
        "options": [
            { "id": 1, "text": "daily", "correct": true },
            { "id": 2, "text": "dairy", "correct": false },
            { "id": 3, "text": "dial", "correct": false },
            { "id": 4, "text": "pile", "correct": false }
        ],
        "explanation": "\"daily routine\" = الروتين اليومي."
    },
    {
        "id": 18,
        "type": "multiple-choice",
        "text": "___ is the opposite of dirty or ugly.",
        "options": [
            { "id": 1, "text": "Active", "correct": false },
            { "id": 2, "text": "Terrible", "correct": false },
            { "id": 3, "text": "Attractive", "correct": true },
            { "id": 4, "text": "Sod", "correct": false }
        ],
        "explanation": "\"Attractive\" تعني جذاب، ومضاد \"ugly\" و\"dirty\"."
    },
    {
        "id": 19,
        "type": "multiple-choice",
        "text": "She doesn't ___ to school on foot.",
        "options": [
            { "id": 1, "text": "go", "correct": true },
            { "id": 2, "text": "goes", "correct": false },
            { "id": 3, "text": "going", "correct": false },
            { "id": 4, "text": "went", "correct": false }
        ],
        "explanation": "بعد \"doesn't\" يأتي الفعل في المصدر (go)."
    },
    {
        "id": 20,
        "type": "multiple-choice",
        "text": "I always keep my clothes in a ___.",
        "options": [
            { "id": 1, "text": "prison", "correct": false },
            { "id": 2, "text": "cinema", "correct": false },
            { "id": 3, "text": "carpet", "correct": false },
            { "id": 4, "text": "wardrobe", "correct": true }
        ],
        "explanation": "\"wardrobe\" = خزانة الملابس."
    },
    {
        "id": 21,
        "type": "multiple-choice",
        "text": "The police arrested the thief and took him to ___.",
        "options": [
            { "id": 1, "text": "prison", "correct": true },
            { "id": 2, "text": "funfair", "correct": false },
            { "id": 3, "text": "Dream Park", "correct": false },
            { "id": 4, "text": "theatre", "correct": false }
        ],
        "explanation": "المجرمون يُؤخذون إلى السجن."
    },
    {
        "id": 22,
        "type": "multiple-choice",
        "text": "Has she ___ a new bag?",
        "options": [
            { "id": 1, "text": "get", "correct": false },
            { "id": 2, "text": "gels", "correct": false },
            { "id": 3, "text": "getting", "correct": false },
            { "id": 4, "text": "got", "correct": true }
        ],
        "explanation": "\"Has she got\" = هل عندها؟ (صيغة شائعة في اللغة البريطانية)."
    },
    {
        "id": 23,
        "type": "multiple-choice",
        "text": "The ___ broke, so there was glass everywhere.",
        "options": [
            { "id": 1, "text": "carpet", "correct": false },
            { "id": 2, "text": "curtain", "correct": false },
            { "id": 3, "text": "mirror", "correct": true },
            { "id": 4, "text": "comb", "correct": false }
        ],
        "explanation": "المرايا مصنوعة من الزجاج، وعند كسرها ينتشر الزجاج."
    },
    {
        "id": 24,
        "type": "multiple-choice",
        "text": "My ___ of flats is over there.",
        "options": [
            { "id": 1, "text": "black", "correct": false },
            { "id": 2, "text": "blog", "correct": false },
            { "id": 3, "text": "log", "correct": false },
            { "id": 4, "text": "block", "correct": true }
        ],
        "explanation": "\"block of flats\" = عمارة سكنية."
    },
    {
        "id": 25,
        "type": "multiple-choice",
        "text": "He ___ walk, so he uses a wheelchair.",
        "options": [
            { "id": 1, "text": "can", "correct": false },
            { "id": 2, "text": "can't", "correct": true },
            { "id": 3, "text": "don't", "correct": false },
            { "id": 4, "text": "hasn't", "correct": false }
        ],
        "explanation": "يستخدم كرسي متحرك → إذًا لا يستطيع المشي."
    },
    {
        "id": 26,
        "type": "multiple-choice",
        "text": "In the library, they keep the books on ___.",
        "options": [
            { "id": 1, "text": "windows", "correct": false },
            { "id": 2, "text": "wardrobes", "correct": false },
            { "id": 3, "text": "bookshelves", "correct": true },
            { "id": 4, "text": "glasses", "correct": false }
        ],
        "explanation": "الكتب تُحفظ على رفوف الكتب في المكتبة."
    },
    {
        "id": 27,
        "type": "fill-in-blank",
        "text": "She ___ clever at helping people. (always / is)",
        "correctAnswer": "She is always clever at helping people.",
        "explanation": "\"always\" توضع بعد \"be\" أو قبل الأفعال العادية."
    },
    {
        "id": 28,
        "type": "fill-in-blank",
        "text": "He usually ___ carefully. (drives)",
        "correctAnswer": "He usually drives carefully.",
        "explanation": "\"usually\" تسبق الفعل."
    },
    {
        "id": 29,
        "type": "fill-in-blank",
        "text": "___ Ali got a camera? (Have)",
        "correctAnswer": "Has Ali got a camera?",
        "explanation": "سؤال بـ\"Have\" مع \"Ali\" (he) → يصبح \"Has\"."
    },
    {
        "id": 30,
        "type": "fill-in-blank",
        "text": "The man can ___ the car. (drive)",
        "correctAnswer": "The man can drive the car.",
        "explanation": "بعد \"can\" يأتي الفعل في المصدر (drive)."
    }
        ]
    };

   // متغيرات
    let currentQuestionIndex = 0;
    let userAnswers = {};
    let answered = {};

    // تحميل البيانات المحفوظة
    function loadSavedData() {
        const saved = localStorage.getItem(`exam_${examId}`);
        if (saved) {
            const data = JSON.parse(saved);
            userAnswers = data.answers || {};
            currentQuestionIndex = data.currentQuestionIndex || 0;
            return true;
        }
        return false;
    }

    // حفظ البيانات
    function saveData() {
        const data = {
            answers: userAnswers,
            currentQuestionIndex: currentQuestionIndex,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem(`exam_${examId}`, JSON.stringify(data));
    }

    // الحصول على رقم السؤال الحقيقي (باستثناء النصوص والشعر)
    function getQuestionNumber(index) {
        let realCount = 0;
        for (let i = 0; i <= index; i++) {
            if (examData.questions[i].type !== "passage" && examData.questions[i].type !== "poem") {
                realCount++;
            }
        }
        return realCount;
    }

    // تحديث زر التالي
    function updateNextButton() {
        const nextBtn = document.getElementById('next-btn');
        const currentQuestion = examData.questions[currentQuestionIndex];
        
        // إذا كان السؤال الحالي نصًا أو شعرًا، فعّل الزر مباشرة
        if (currentQuestion.type === "passage" || currentQuestion.type === "poem") {
            nextBtn.disabled = false;
            return;
        }
        
        // تحقق مما إذا كان السؤال الحالي قد تمت الإجابة عليه
        nextBtn.disabled = !answered[currentQuestionIndex];
    }

    // تحديد خيار في سؤال متعدد الخيارات
    function selectOption(element, questionId, optionId, isCorrect) {
        // منع التحديد إذا كانت الإجابة معروضة بالفعل
        if (userAnswers[questionId]) return;
        
        // إلغاء تحديد جميع الخيارات الأخرى
        const options = document.querySelectorAll(`.option[data-question="${questionId}"]`);
        options.forEach(opt => opt.classList.remove('selected'));
        
        // تحديد الخيار الحالي
        element.classList.add('selected');
        
        // حفظ الإجابة
        userAnswers[questionId] = {
            selected: optionId,
            correct: isCorrect
        };
        
        // تشغيل الصوت المناسب
        if (isCorrect) {
            correctSound.play();
        } else {
            incorrectSound.play();
        }
        
        // عرض التفسير
        const explanationEl = document.getElementById(`explanation-${questionId}`);
        if (explanationEl) {
            explanationEl.style.display = 'block';
        }
        
        // تمييز الإجابة الصحيحة والخاطئة
        options.forEach(opt => {
            const optCorrect = opt.getAttribute('data-correct') === 'true';
            if (optCorrect) {
                opt.classList.add('correct');
            } else if (parseInt(opt.getAttribute('data-option')) === optionId && !isCorrect) {
                opt.classList.add('incorrect');
            }
        });
        
        // تمكين زر التالي
        answered[currentQuestionIndex] = true;
        updateNextButton();
        saveData();
    }

    // معالجة إدخال الإجابة في الأسئلة المقالية
    function onFillInput(questionId) {
        const input = document.getElementById(`fill-${questionId}`);
        userAnswers[questionId] = {
            answer: input.value
        };
        
        // تمكين زر التالي إذا كان هناك إدخال
        if (input.value.trim() !== '') {
            answered[currentQuestionIndex] = true;
        } else {
            answered[currentQuestionIndex] = false;
        }
        
        updateNextButton();
        saveData();
    }

    // الانتقال إلى السؤال التالي
    function nextQuestion() {
        const currentId = examData.questions[currentQuestionIndex].id;
        document.getElementById(`question-${currentId}`).style.display = 'none';
        
        if (currentQuestionIndex < examData.questions.length - 1) {
            currentQuestionIndex++;
            const nextId = examData.questions[currentQuestionIndex].id;
            document.getElementById(`question-${nextId}`).style.display = 'block';
            
            // تحديث رقم السؤال الحالي
            document.getElementById('current-question').textContent = getQuestionNumber(currentQuestionIndex);
            
            // تمكين أو تعطيل أزرار التنقل
            document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
            
            // إذا كان السؤال تاليًا نصًا أو شعرًا، فعّل الزر مباشرة
            const nextQ = examData.questions[currentQuestionIndex];
            if (nextQ.type === "passage" || nextQ.type === "poem") {
                answered[currentQuestionIndex] = true;
                document.getElementById('next-btn').disabled = false;
            } else {
                updateNextButton();
            }
            
            saveData();
        } else {
            showResults();
        }
    }

    // الانتقال إلى السؤال السابق
    function prevQuestion() {
        const currentId = examData.questions[currentQuestionIndex].id;
        document.getElementById(`question-${currentId}`).style.display = 'none';
        
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            const prevId = examData.questions[currentQuestionIndex].id;
            document.getElementById(`question-${prevId}`).style.display = 'block';
            
            // تحديث رقم السؤال الحالي
            document.getElementById('current-question').textContent = getQuestionNumber(currentQuestionIndex);
            
            // تمكين أو تعطيل أزرار التنقل
            document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
            updateNextButton();
            
            saveData();
        }
    }

    // عرض النتائج
// عرض النتائج - بدون حساب الأسئلة المقالية في الدرجة
function showResults() {
    // حساب النتيجة: فقط الأسئلة متعددة الخيارات
    let correctCount = 0;
    let totalQuestions = 0;

    examData.questions.forEach(q => {
        if (q.type === "multiple-choice") {
            totalQuestions++;
            if (userAnswers[q.id] && userAnswers[q.id].correct) {
                correctCount++;
            }
        }
    });

    // حساب النسبة المئوية بناءً على الأسئلة متعددة الخيارات فقط
    const score = totalQuestions > 0 ? Math.round((correctCount / totalQuestions) * 100) : 0;

    // كلمات تشجيعية
    let feedback = "";
    if (score >= 90) feedback = "ممتاز! أحسنت، استمر على هذا النحو 🌟";
    else if (score >= 75) feedback = "جيد جدًا! أداء رائع 👏";
    else if (score >= 60) feedback = "جيد، يمكنك التحسن أكثر 💪";
    else feedback = "لا بأس، راجع الدروس وحاول مرة أخرى ❤️";

    // توصيات
    let recommendations = "";
    if (score < 60) {
        recommendations = "ننصحك بمراجعة القواعد النحوية والبلاغية، وحل المزيد من الأسئلة.";
    } else if (score < 80) {
        recommendations = "أداء جيد، ركّز على أنواع الأسئلة التي أخطأت فيها.";
    } else {
        recommendations = "أداء ممتاز! استمر في التقدم وجرّب امتحانات أصعب.";
    }

    // بناء النتائج التفصيلية
    let detailedResults = '';
    let questionNumber = 0; // رقم السؤال الحقيقي (للأسئلة القابلة للتصحيح فقط)

    examData.questions.forEach(q => {
        const userAnswer = userAnswers[q.id];
        let answerText = 'لم تُجب';
        let statusText = 'لم تُجب ❌';

        // عرض الفقرات والشعر
        if (q.type === "passage") {
            detailedResults += `
                <div class="result-item">
                    <h4>📖 فقرة نصية</h4>
                    <div class="passage">${q.content.replace(/\n/g, '<br>')}</div>
                </div>
            `;
            return;
        }

        if (q.type === "poem") {
            detailedResults += `
                <div class="result-item">
                    <h4>📜 نص شعري</h4>
                    <div class="poem">${q.content.replace(/\n/g, '<br>')}</div>
                </div>
            `;
            return;
        }

        // زيادة رقم السؤال فقط للأسئلة القابلة للتصحيح (اختيار من متعدد)
        if (q.type === "multiple-choice") {
            questionNumber++;
        }

        // معالجة الإجابة
        if (q.type === "multiple-choice") {
            const selectedOption = q.options.find(opt => opt.id == userAnswer?.selected);
            answerText = selectedOption ? selectedOption.text : 'لم تُجب';
            
            if (userAnswer && selectedOption?.correct) {
                statusText = 'إجابة صحيحة ✅';
            } else if (userAnswer && !selectedOption?.correct) {
                statusText = 'إجابة خاطئة ❌';
            } else {
                statusText = 'لم تُجب ❌';
            }
        } 
        else if (q.type === "fill-in-blank") {
            // السؤال المقالي: يظهر لكن بدون تأثير على العد
            answerText = userAnswer?.answer?.trim() || 'لم تُجب';
            statusText = (userAnswer && answerText !== 'لم تُجب') ? 'تمت الإجابة (تحت المراجعة)' : 'لم تُجب ❌';
        }

        // عرض السؤال بالشكل المطلوب
        detailedResults += `
            <div class="result-item">
                ${q.type === "multiple-choice" ? `<p><strong>السؤال ${questionNumber}: ${q.text}</strong></p>` : `<p><strong>${q.text}</strong></p>`}
                <p><strong>إجابتك:</strong> ${answerText}</p>
                <p><strong>الحالة:</strong> ${statusText}</p>
                <p><strong>📌 التفسير الكامل:</strong> ${q.explanation}</p>
            </div>
        `;
    });

    // عرض النتيجة النهائية
    document.getElementById('score').innerHTML = `
        <div class="stats">الإجابات الصحيحة: ${correctCount} من ${totalQuestions}</div>
        <div class="stats">النسبة المئوية: ${score}%</div>
        <div class="feedback">${feedback}</div>
        <div class="recommendations"><strong>توصية:</strong> ${recommendations}</div>
    `;

    document.getElementById('detailed-results').innerHTML = detailedResults;

    // إخفاء الأسئلة وإظهار النتائج
    document.getElementById('questions-container').style.display = 'none';
    document.querySelector('.navigation').style.display = 'none';
    document.querySelector('.controls').style.display = 'flex';
    document.getElementById('results-container').style.display = 'block';
}
    // طباعة النتائج
    function printResults() {
        window.print();
    }

    // مشاركة النتائج
    function shareResults() {
        if (navigator.share) {
            navigator.share({
                title: 'نتيجة الامتحان',
                text: `حصلت على ${document.getElementById('score').textContent} في امتحان اللغة العربية`,
                url: window.location.href
            })
            .catch(error => {
                console.log('Error sharing:', error);
                alert('لم يتمكن المتصفح من مشاركة النتائج. يرجى المحاولة لاحقًا.');
            });
        } else {
            alert('مشاركة النتائج غير مدعومة في هذا المتصفح. يمكنك استخدام زر الطباعة بدلاً من ذلك.');
        }
    }

    // إعادة بدء الامتحان
    function restartExam() {
        if (confirm('هل تريد إعادة بدء الامتحان؟ سيتم حذف جميع إجاباتك الحالية.')) {
            userAnswers = {};
            answered = {};
            currentQuestionIndex = 0;
            localStorage.removeItem(`exam_${examId}`);
            location.reload();
        }
    }

    // العودة إلى قائمة الامتحانات
    function backToExams() {
        if (confirm('هل تريد العودة إلى قائمة الامتحانات؟ سيتم فقدان تقدمك الحالي إذا لم تحفظه.')) {
            window.location.href = '/questions.html'; // تغيير هذا الرابط حسب الصفحة المناسبة
        }
    }

    // تهيئة الامتحان
    function initExam() {
        const container = document.getElementById('questions-container');
        const totalQuestions = examData.questions.filter(q => q.type !== "passage" && q.type !== "poem").length;
        document.getElementById('total-questions').textContent = totalQuestions;
        document.getElementById('current-question').textContent = getQuestionNumber(currentQuestionIndex);

        // تحميل الحالة
        const wasResumed = loadSavedData();

        // إنشاء الأسئلة
        examData.questions.forEach((q, index) => {
            const questionEl = document.createElement('div');
            questionEl.className = 'question';
            questionEl.id = `question-${q.id}`;
            questionEl.style.display = index === currentQuestionIndex ? 'block' : 'none';

            if (q.type === "passage") {
                questionEl.innerHTML = `<div class="passage">${q.content.replace(/\n/g, '<br>')}</div>`;
                // تمييز أسئلة النص كأسئلة تمت الإجابة عليها تلقائيًا
                answered[index] = false;
            } else if (q.type === "poem") {
                questionEl.innerHTML = `<div class="poem">${q.content.replace(/\n/g, '<br>')}</div>`;
                // تمييز أسئلة الشعر كأسئلة تمت الإجابة عليها تلقائيًا
                answered[index] = false;
            } else {
                let content = `<h3>السؤال ${getQuestionNumber(index)}: ${q.text}</h3>`;

                if (q.type === "multiple-choice") {
                    let optionsHtml = '<div class="options">';
                    q.options.forEach(opt => {
                        const selected = userAnswers[q.id]?.selected == opt.id;
                        const isAnswered = userAnswers[q.id];
                        const correct = opt.correct;
                        optionsHtml += `
                            <div class="option ${selected ? 'selected' : ''} ${isAnswered && correct ? 'correct' : ''} ${isAnswered && !correct && selected ? 'incorrect' : ''}"
                                 data-question="${q.id}" data-option="${opt.id}" data-correct="${opt.correct}"
                                 onclick="selectOption(this, ${q.id}, ${opt.id}, ${opt.correct})">
                                ${opt.text}
                            </div>
                        `;
                    });
                    optionsHtml += '</div>';
                    content += optionsHtml;
                } else if (q.type === "fill-in-blank") {
                    const value = userAnswers[q.id]?.answer || '';
                    content += `
                        <div class="fill-in-blank">
                            <input type="text" id="fill-${q.id}" value="${value}" placeholder="أدخل إجابتك هنا" oninput="onFillInput(${q.id})">
                        </div>
                    `;
                }

                content += `<div class="explanation" id="explanation-${q.id}" style="${userAnswers[q.id] ? 'display:block' : 'display:none'}">
                    <strong>التفسير:</strong> ${q.explanation}
                </div>`;
                questionEl.innerHTML = content;
                
                // تحديد ما إذا كان السؤال قد تمت الإجابة عليه
                answered[index] = !!userAnswers[q.id];
            }

            container.appendChild(questionEl);
        });

        // تحديث زر التالي بناءً على السؤال الحالي
        updateNextButton();

        // ربط الأحداث
        document.getElementById('next-btn').addEventListener('click', nextQuestion);
        document.getElementById('prev-btn').addEventListener('click', prevQuestion);
        document.getElementById('print-btn').addEventListener('click', printResults);
        document.getElementById('share-btn').addEventListener('click', shareResults);
        document.getElementById('restart-btn').addEventListener('click', restartExam);
        document.getElementById('back-btn').addEventListener('click', backToExams);

        if (wasResumed) {
            alert(`تم استئناف الامتحان من السؤال ${getQuestionNumber(currentQuestionIndex)}`);
        }
    }

    // بدء الامتحان عند تحميل الصفحة
    window.onload = initExam;
</script>
</body>
</html>