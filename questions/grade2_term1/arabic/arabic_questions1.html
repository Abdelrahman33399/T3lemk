<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار اللغة العربية - الصف الثاني الإعدادي</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* أنماط عامة */
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        /* الحاوية الرئيسية */
        .exam-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        
        /* رأس الامتحان */
        .exam-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #007bff;
        }
        
        .exam-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        /* إحصائيات الأسئلة */
        .stats {
            background: #e9f5ff;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
            border-right: 4px solid #007bff;
        }
        
        /* الأسئلة */
        .question {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #fafafa;
            transition: all 0.3s ease;
        }
        
        .question:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .question h3 {
            color: #007bff;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }
        
        /* النصوص والقصائد */
        .passage, .poem {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            line-height: 1.8;
            font-style: italic;
            border-right: 4px solid #6c757d;
        }
        
        .poem {
            text-align: center;
            font-weight: bold;
            background: #fff9e6;
            border-right-color: #ffc107;
        }
        
        /* خيارات الأسئلة */
        .options {
            margin: 20px 0;
        }
        
        .option {
            margin-bottom: 10px;
            padding: 12px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
            background: white;
        }
        
        .option:hover {
            background-color: #e9f5ff;
            transform: translateX(-5px);
        }
        
        .option.selected {
            background-color: #d4edff;
            border-left: 4px solid #007bff;
        }
        
        .option.correct {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .option.incorrect {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        
        /* شرح الإجابة */
        .explanation {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-right: 3px solid #6c757d;
        }
        
        /* حقول الإدخال */
        .fill-in-blank input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .fill-in-blank input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        /* التنقل بين الأسئلة */
        .navigation {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
        }
        
        /* الأزرار */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #0069d9;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background-color: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background-color: #218838;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background-color: #c82333;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover:not(:disabled) {
            background-color: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-info:hover:not(:disabled) {
            background-color: #138496;
            transform: translateY(-2px);
        }
        
        /* النتائج */
        .results-container {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .score {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
            color: #007bff;
        }
        
        .feedback {
            text-align: center;
            font-size: 18px;
            margin: 15px 0;
            color: #28a745;
            font-weight: bold;
        }
        
        .result-item {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .recommendations {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ffeaa7;
        }
        
        .correct-answer {
            color: #28a745;
            font-weight: bold;
        }
        
        /* عناصر التحكم */
        .controls {
            margin-top: 30px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* التكيف مع الشاشات الصغيرة */
        @media (max-width: 768px) {
            .exam-container {
                padding: 15px;
            }
            
            .navigation {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .question {
                padding: 15px;
            }
            
            .passage, .poem {
                padding: 15px;
            }
        }
    </style></head>
<body>
    <div class="exam-container">
        <div class="exam-header">
            <h1 id="exam-title">اختبار اللغة العربية - الصف الثاني الإعدادي (الوحدة الأولي) - الترم الأول</h1>
        </div>
        
        <div class="stats">السؤال <span id="current-question">1</span> من <span id="total-questions">26</span></div>
        
        <div id="questions-container"></div>
        
        <div class="navigation">
            <button id="prev-btn" class="btn btn-secondary" disabled>السابق</button>
            <button id="next-btn" class="btn btn-primary">التالي</button>
        </div>
        
        <div class="controls">
            <button id="restart-btn" class="btn btn-warning">إعادة البدء</button>
            <button id="print-btn" class="btn btn-info">طباعة النتائج</button>
            <button id="share-btn" class="btn btn-success">مشاركة النتائج</button>
            <button id="back-btn" class="btn btn-danger">العودة للامتحانات</button>
        </div>
        
        <div class="results-container" id="results-container">
            <h2>النتيجة</h2>
            <div id="score"></div>
            <div id="detailed-results"></div>
        </div>
    </div>

    <audio id="correctSound" src="../../../assets/audio/correct.mp3" preload="auto"></audio>
    <audio id="incorrectSound" src="../../../assets/audio/incorrect.mp3" preload="auto"></audio>


   <script>
    // أصوات
    const correctSound = document.getElementById('correctSound');
    const incorrectSound = document.getElementById('incorrectSound');

    // معرف الامتحان
    const examId = "arabic-grade1-term1";

    // بيانات الأسئلة (كما أرسلتها)
    const examData = {
        title: "اختبار اللغة العربية - الصف الثاني الإعدادي (الوحدة الأولي) - الترم الأول",
        questions: [
            {
        "id": 1,
        "type": "fill-in-blank",
        "text": "ما الدور البارز الذي لعبته زينب الكفراوي في مقاومة الاحتلال؟",
        "correctAnswer": "كانت من أوائل النساء اللاتي شاركن في مقاومة الاحتلال البريطاني، حيث أطلقت الرصاص على الجنود البريطانيين أثناء اجتياحهم لقريتها \"الكفراوي\" في 1919، ورفضت الاستسلام. رمز للمرأة المصرية المقاومة، وشاركت في ثورة 1919 ببسالة.",
        "explanation": "زينب الكفراوي كانت من أبرز رموز المقاومة النسائية في الثورة المصرية عام 1919."
    },
    {
        "id": 2,
        "type": "fill-in-blank",
        "text": "على ماذا يدل قوله: \"إلا أنها كسرت الصورة النمطية\"؟",
        "correctAnswer": "يدل على أن المرأة المصرية لم تعد مجرد ربة منزل، بل أصبحت فاعلة في الحياة العامة، وقادرة على المشاركة في النضال الوطني، مما يكسر الصورة النمطية التي تقلل من دور المرأة.",
        "explanation": "هذا التعبير يعكس التحول في دور المرأة المصرية من المنزل إلى الساحة الوطنية."
    },
    {
        "id": 3,
        "type": "multiple-choice",
        "text": "مرادفات كلمة \"مستقيم\": (ظاهرا، وواضحا – تابتا، وقويا – مستمرا، ودائما – متواليا، ومتتابعا)",
        "options": [
            { "id": 1, "text": "ظاهرا، وواضحا", "correct": false },
            { "id": 2, "text": "تابتا، وقويا", "correct": true },
            { "id": 3, "text": "مستمرا، ودائما", "correct": false },
            { "id": 4, "text": "متواليا، ومتتابعا", "correct": false }
        ],
        "explanation": "\"مستقيم\" تعني ثابتًا، قويًا في الموقف، لا ينثني أمام الصعاب."
    },
    {
        "id": 4,
        "type": "multiple-choice",
        "text": "مضاد كلمة \"بسالة\": (شجاعة – ضعف – جبن – حزن)",
        "options": [
            { "id": 1, "text": "شجاعة", "correct": false },
            { "id": 2, "text": "ضعف", "correct": false },
            { "id": 3, "text": "جبن", "correct": true },
            { "id": 4, "text": "حزن", "correct": false }
        ],
        "explanation": "البسالة تعني الشجاعة، ومضادها \"الجبن\"."
    },
    {
        "id": 5,
        "type": "multiple-choice",
        "text": "علاقة قوله: \"ليتحقق بذلك أول نصر حقيقي\" بما قبله: (تعليل – نتيجة – توضيح – توكيد)",
        "options": [
            { "id": 1, "text": "تعليل", "correct": false },
            { "id": 2, "text": "نتيجة", "correct": true },
            { "id": 3, "text": "توضيح", "correct": false },
            { "id": 4, "text": "توكيد", "correct": false }
        ],
        "explanation": "\"ليتحقق النصر\" هو نتيجة لعبور الجيش وتدمير خط بارليف."
    },
    {
        "id": 6,
        "type": "fill-in-blank",
        "text": "ما عوامل تحقيق النصر كما تفهم من النص؟",
        "correctAnswer": "الإيمان بالوطن، التخطيط المحكم، الشجاعة والبسالة، التضحيات الجسيمة، وحدة الصف العربي",
        "explanation": "النص يوضح أن النصر لم يكن صدفة، بل نتيجة لعوامل بشرية وروحية وتنظيمية."
    },
    {
        "id": 7,
        "type": "fill-in-blank",
        "text": "على ماذا يدل قوله: \"كتب فيه الجندي المصري بدمه الطاهر ملحمة خالدة\"؟",
        "correctAnswer": "يدل على أن الجندي المصري ضحّى بحياته من أجل الوطن، وخلّد بطولته بالتضحيات، فكانت دماءه شهادة على عزة مصر وكرامتها.",
        "explanation": "هذا التعبير يعكس البطولة والتضحية في سبيل الوطن."
    },
    {
        "id": 8,
        "type": "fill-in-blank",
        "text": "استنتج الشعور العام في النص، مع ذكر الكلمات الدالة عليه.",
        "correctAnswer": "الشعور العام: الفخر، العزة، والانتماء. الكلمات الدالة: \"ملحمة خالدة\"، \"شجاعة وبسالة\"، \"استرداد الكرامة\"، \"فخر وعزة\"، \"وحدة القلوب\"",
        "explanation": "النص يعبر عن مشاعر الفخر والانتماء الوطني."
    },
    {
        "id": 9,
        "type": "multiple-choice",
        "text": "مرادف \"يتَهَيَّبُوا\": (يخشوا، ويخافوا – يتراخوا، ويتكاسلوا – يخضعوا، ويَتِلُوا – يضعفوا، ويتهارون)",
        "options": [
            { "id": 1, "text": "يخشوا، ويخافوا", "correct": true },
            { "id": 2, "text": "يتراخوا، ويتكاسلوا", "correct": false },
            { "id": 3, "text": "يخضعوا، ويَتِلُوا", "correct": false },
            { "id": 4, "text": "يضعفوا، ويتهارون", "correct": false }
        ],
        "explanation": "\"يتَهَيَّبُوا\" تعني يخافون، لذا مرادفها \"يخشوا\"."
    },
    {
        "id": 10,
        "type": "multiple-choice",
        "text": "مضاد \"مغواره\": (متخاذل – جبان – يابس – قليل)",
        "options": [
            { "id": 1, "text": "متخاذل", "correct": false },
            { "id": 2, "text": "جبان", "correct": true },
            { "id": 3, "text": "يابس", "correct": false },
            { "id": 4, "text": "قليل", "correct": false }
        ],
        "explanation": "\"مغواره\" تعني شجاع، ومضادها \"جبان\"."
    },
    {
        "id": 11,
        "type": "multiple-choice",
        "text": "علاقة قوله: \"يَلقَى المَمَاتَ المُرَّ وَهُوَ سَعِيدُ\" بما قبله: (تعليل – توضيح – نتيجة – تفصيل)",
        "options": [
            { "id": 1, "text": "تعليل", "correct": false },
            { "id": 2, "text": "توضيح", "correct": true },
            { "id": 3, "text": "نتيجة", "correct": false },
            { "id": 4, "text": "تفصيل", "correct": false }
        ],
        "explanation": "الجملة توضح أن الشهيد يواجه الموت بقلب شجاع، وهو سعيد بالتضحية."
    },
    {
        "id": 12,
        "type": "fill-in-blank",
        "text": "المعنى المتضمن في قوله: \"قد سهرت عليك أُسودُها\":",
        "correctAnswer": "اليقظة والاستعداد لمواجهة الكائبين",
        "explanation": "\"الأسود\" ترمز للجنود، و\"سهرت\" تعني أنهم دائمًا في حالة تأهب لحماية الوطن."
    },
    {
        "id": 13,
        "type": "fill-in-blank",
        "text": "وضح الدور البطولي لأبناء مصر من البيتين الثالث والرابع.",
        "correctAnswer": "صانوا مواقعهم حتى الموت، لم ينسحبوا شبرا واحدا، تصدوا للمعتدين وقتلوا أضعفهم، رددوا اسم مصر حتى الشهادة، دلالة على التمسك بالأرض، والتضحية من أجل الوطن.",
        "explanation": "البيتان يعبران عن البطولة والتضحية في سبيل الوطن."
    },
    {
        "id": 14,
        "type": "fill-in-blank",
        "text": "علام يدل قوله: \"لم يرجعوا شبرا\"؟",
        "correctAnswer": "يدل على الثبات والصمود، وعدم التراجع أمام العدو، مهما كانت التضحيات.",
        "explanation": "هذا التعبير يعكس العزيمة والثبات في وجه الخطر."
    },
    {
        "id": 15,
        "type": "fill-in-blank",
        "text": "علام يدل قوله: \"ولمصر في أفواههم ترديد\"؟",
        "correctAnswer": "يدل على أن الشهداء ما زالوا ينادون باسم مصر حتى لحظة الشهادة، مما يعكس حبهم العميق للوطن.",
        "explanation": "هذا التعبير يظهر الحب العميق للوطن حتى لحظة التضحية."
    },
    {
        "id": 16,
        "type": "fill-in-blank",
        "text": "أعرب ما تحته خط: \"المخلصون – يتقلون – العمل – عزيمتهم – فاحرص – لتُعِش سعيدًا – يجتهد – ينل\"",
        "correctAnswer": "المخلصون: مبتدأ مرفوع، وعلامة رفعه الواو لأنه جمع مذكر سالم. يتقلون: فعل مضارع مرفوع، وعلامة رفعه ثبوت النون (للجماعة). العمل: مفعول به منصوب، وعلامة نصبه الفتحة. عزيمتهم: مفعول به منصوب، وعلامة نصبه الفتحة، \"هم\" ضمير متصل في محل جر مضاف إليه. فاحرص: فعل أمر مبني على السكون، والفاعل ضمير مستتر \"أنت\". لتُعِش سعيدًا: \"لتُعِش\" فعل مضارع منصوب بأن المضمرة، \"سعيدًا\" حال منصوب. يجتهد: فعل مضارع مرفوع، وعلامة رفعه الضمة. ينل: فعل مضارع مرفوع، وعلامة رفعه الضمة.",
        "explanation": "الإعراب الكامل للكلمات المطلوبة في النص."
    },
    {
        "id": 17,
        "type": "fill-in-blank",
        "text": "استخرج اسمين مبنيين مختلفين، وحدد نوعيهما.",
        "correctAnswer": "أحد → اسم معطوف على \"جزاءً\"، مبني على الفتح لأنه نكرة في محل نصب. أبواك → فاعل مرفوع، مبني على الضم لأنه مثنى.",
        "explanation": "استخراج وتحليل الأسماء المبنية في النص."
    },
    {
        "id": 18,
        "type": "fill-in-blank",
        "text": "استخرج اسمين مقصورين، أحدهما بعلامة أصلية، والآخر فرعية.",
        "correctAnswer": "سعيدًا → اسم مقصور، علامة إعرابه الفتحة (علامة أصلية). أحد → اسم مقصور، علامة إعرابه الفتحة (علامة فرعية، لأنه نكرة منصوبة).",
        "explanation": "تحديد الأسماء المقصورة ونوع علامات إعرابها."
    },
    {
        "id": 19,
        "type": "fill-in-blank",
        "text": "استخرج فعلًا من الأفعال الخمسة مرفوعًا، وحدد علامة الرفع.",
        "correctAnswer": "يفخر → فعل من الأفعال الخمسة، مرفوع، وعلامة رفعه ثبوت النون (للمذكر الجمع). يَنالُ → فعل مضارع مرفوع، وعلامة رفعه الضمة.",
        "explanation": "استخراج وتحليل الأفعال الخمسة المبنية على النون."
    },
    {
        "id": 20,
        "type": "fill-in-blank",
        "text": "استخرج مضارعين منصوبين بأداتين مختلفتين، وحدد علامة النصب.",
        "correctAnswer": "أن ينتظروا → \"أن\" حرف نصب، و\"ينتظروا\" فعل مضارع منصوب، وعلامة نصبه حذف النون (لأنه جمع مذكر سالم). لتُعِش → \"لت\" حرف نصب، و\"تعِش\" فعل مضارع منصوب، وعلامة نصبه السكون.",
        "explanation": "تحليل الأفعال المضارعة المنصوبة بأدوات النصب المختلفة."
    },
    {
        "id": 21,
        "type": "fill-in-blank",
        "text": "في الجملة: \"التعطف على الفقير – اجتهد لتنجح\"، حدّد نوع اللام، واعرب الفعل بعدها.",
        "correctAnswer": "اللام: لام الجحود (تُفيد النفي والسببية). تنجح: فعل مضارع منصوب بأن المضمرة، وعلامة نصبه الفتحة.",
        "explanation": "تحليل لام الجحود ووظيفتها النحوية."
    },
    {
        "id": 22,
        "type": "fill-in-blank",
        "text": "\"محمد لا يكذب\"، اجعل الجملة للمخاطب، ثم اعرب الفعل.",
        "correctAnswer": "تصبح الجملة: \"أنت لا تكذب\". تكذب: فعل مضارع مرفوع، وعلامة رفعه ثبوت النون (للمخاطب المذكر المفرد).",
        "explanation": "تحويل الجملة من الغائب إلى المخاطب مع الإعراب الصحيح."
    },
    {
        "id": 23,
        "type": "fill-in-blank",
        "text": "\"ينال التفوق من يجتهد في دروسه\"، حدّد نوع (من).",
        "correctAnswer": "من: اسم موصول في محل رفع فاعل، أي: \"الذي يجتهد\".",
        "explanation": "تحليل وظيفة اسم الموصول في الجملة."
    },
    {
        "id": 24,
        "type": "fill-in-blank",
        "text": "اكتب مقالًا وصفيًا عن سيناء الحبيبة (130 - 170 كلمة)",
        "correctAnswer": "سيناء، أرض العزة والبطولة، تمتد بين بحرَيْن، خليج السويس والعقبة، تفوح منها رائحة التاريخ والبطولة. جبالها الشامخة، مثل جبل كاترين، تناجي السماء، وصحاريها الشاسعة تحكي ملاحم التحدي. شواطئها الزرقاء الصافية تجذب السياح من كل حدب وصوب. سيناء ليست فقط جمالًا طبيعيًا، بل هي قلب مصر النابض، حيث دوّى صوت \"العبور\" في أكتوبر 1973، وكتب الجندي المصري ملحمة الكرامة. كل رملة في سيناء تشهد على دماء الشهداء، وعلى عزيمة الشعب. اليوم، تشهد سيناء تنمية شاملة: طرق جديدة، مدن ذكية، ومصانع تنمو على أرضها الطاهرة. سيناء... أرض الأنبياء، وملحمة الأبطال، ورمز العزة. نحبك يا سيناء، ونعتز بك دائمًا.",
        "explanation": "مقال وصفي يعبر عن جمال وعظمة سيناء وأهميتها التاريخية والوطنية."
    },
    {
        "id": 25,
        "type": "fill-in-blank",
        "text": "تحدث في ندوة بعنوان \"الوطنية والانتماء\" عن المفهوم الحقيقي للوطنية.",
        "correctAnswer": "الوطنية ليست مجرد هتافات أو علم على السيارة، بل هي: الحفاظ على الممتلكات العامة، الالتزام بالقانون، العمل بجد من أجل تقدم الوطن، الدفاع عنه في السلم والحرب. الوطنية أن تُحب وطنك بما فيه، وتعمل على تطويره، وتُفخر به دون تعصب. الوطن لا يُبنى بالكلام، بل بالعمل. فليكن كل منا نموذجًا في الوطنية، بالصدق، الأمانة، والاجتهاد.",
        "explanation": "عرض مفهوم الوطنية الحقيقي وأهمية ترسيخه في النفوس."
    },
    {
        "id": 26,
        "type": "fill-in-blank",
        "text": "صوب الخطأ: \"نجى البطل من الهلالي\"",
        "correctAnswer": "نجا البطل من الهلاك أو نجا البطل من الهجوم",
        "explanation": "\"الهلالي\" ليست كلمة صحيحة في هذا السياق. المقصود: \"الهلاك\" أو \"الهجوم\"."
    }
        ]
    };

   // متغيرات
    let currentQuestionIndex = 0;
    let userAnswers = {};
    let answered = {};

    // تحميل البيانات المحفوظة
    function loadSavedData() {
        const saved = localStorage.getItem(`exam_${examId}`);
        if (saved) {
            const data = JSON.parse(saved);
            userAnswers = data.answers || {};
            currentQuestionIndex = data.currentQuestionIndex || 0;
            return true;
        }
        return false;
    }

    // حفظ البيانات
    function saveData() {
        const data = {
            answers: userAnswers,
            currentQuestionIndex: currentQuestionIndex,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem(`exam_${examId}`, JSON.stringify(data));
    }

    // الحصول على رقم السؤال الحقيقي (باستثناء النصوص والشعر)
    function getQuestionNumber(index) {
        let realCount = 0;
        for (let i = 0; i <= index; i++) {
            if (examData.questions[i].type !== "passage" && examData.questions[i].type !== "poem") {
                realCount++;
            }
        }
        return realCount;
    }

    // تحديث زر التالي
    function updateNextButton() {
        const nextBtn = document.getElementById('next-btn');
        const currentQuestion = examData.questions[currentQuestionIndex];
        
        // إذا كان السؤال الحالي نصًا أو شعرًا، فعّل الزر مباشرة
        if (currentQuestion.type === "passage" || currentQuestion.type === "poem") {
            nextBtn.disabled = false;
            return;
        }
        
        // تحقق مما إذا كان السؤال الحالي قد تمت الإجابة عليه
        nextBtn.disabled = !answered[currentQuestionIndex];
    }

    // تحديد خيار في سؤال متعدد الخيارات
    function selectOption(element, questionId, optionId, isCorrect) {
        // منع التحديد إذا كانت الإجابة معروضة بالفعل
        if (userAnswers[questionId]) return;
        
        // إلغاء تحديد جميع الخيارات الأخرى
        const options = document.querySelectorAll(`.option[data-question="${questionId}"]`);
        options.forEach(opt => opt.classList.remove('selected'));
        
        // تحديد الخيار الحالي
        element.classList.add('selected');
        
        // حفظ الإجابة
        userAnswers[questionId] = {
            selected: optionId,
            correct: isCorrect
        };
        
        // تشغيل الصوت المناسب
        if (isCorrect) {
            correctSound.play();
        } else {
            incorrectSound.play();
        }
        
        // عرض التفسير
        const explanationEl = document.getElementById(`explanation-${questionId}`);
        if (explanationEl) {
            explanationEl.style.display = 'block';
        }
        
        // تمييز الإجابة الصحيحة والخاطئة
        options.forEach(opt => {
            const optCorrect = opt.getAttribute('data-correct') === 'true';
            if (optCorrect) {
                opt.classList.add('correct');
            } else if (parseInt(opt.getAttribute('data-option')) === optionId && !isCorrect) {
                opt.classList.add('incorrect');
            }
        });
        
        // تمكين زر التالي
        answered[currentQuestionIndex] = true;
        updateNextButton();
        saveData();
    }

    // معالجة إدخال الإجابة في الأسئلة المقالية
    function onFillInput(questionId) {
        const input = document.getElementById(`fill-${questionId}`);
        userAnswers[questionId] = {
            answer: input.value
        };
        
        // تمكين زر التالي إذا كان هناك إدخال
        if (input.value.trim() !== '') {
            answered[currentQuestionIndex] = true;
        } else {
            answered[currentQuestionIndex] = false;
        }
        
        updateNextButton();
        saveData();
    }

    // الانتقال إلى السؤال التالي
    function nextQuestion() {
        const currentId = examData.questions[currentQuestionIndex].id;
        document.getElementById(`question-${currentId}`).style.display = 'none';
        
        if (currentQuestionIndex < examData.questions.length - 1) {
            currentQuestionIndex++;
            const nextId = examData.questions[currentQuestionIndex].id;
            document.getElementById(`question-${nextId}`).style.display = 'block';
            
            // تحديث رقم السؤال الحالي
            document.getElementById('current-question').textContent = getQuestionNumber(currentQuestionIndex);
            
            // تمكين أو تعطيل أزرار التنقل
            document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
            
            // إذا كان السؤال تاليًا نصًا أو شعرًا، فعّل الزر مباشرة
            const nextQ = examData.questions[currentQuestionIndex];
            if (nextQ.type === "passage" || nextQ.type === "poem") {
                answered[currentQuestionIndex] = true;
                document.getElementById('next-btn').disabled = false;
            } else {
                updateNextButton();
            }
            
            saveData();
        } else {
            showResults();
        }
    }

    // الانتقال إلى السؤال السابق
    function prevQuestion() {
        const currentId = examData.questions[currentQuestionIndex].id;
        document.getElementById(`question-${currentId}`).style.display = 'none';
        
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            const prevId = examData.questions[currentQuestionIndex].id;
            document.getElementById(`question-${prevId}`).style.display = 'block';
            
            // تحديث رقم السؤال الحالي
            document.getElementById('current-question').textContent = getQuestionNumber(currentQuestionIndex);
            
            // تمكين أو تعطيل أزرار التنقل
            document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
            updateNextButton();
            
            saveData();
        }
    }

    // عرض النتائج
// عرض النتائج - بدون حساب الأسئلة المقالية في الدرجة
function showResults() {
    // حساب النتيجة: فقط الأسئلة متعددة الخيارات
    let correctCount = 0;
    let totalQuestions = 0;

    examData.questions.forEach(q => {
        if (q.type === "multiple-choice") {
            totalQuestions++;
            if (userAnswers[q.id] && userAnswers[q.id].correct) {
                correctCount++;
            }
        }
    });

    // حساب النسبة المئوية بناءً على الأسئلة متعددة الخيارات فقط
    const score = totalQuestions > 0 ? Math.round((correctCount / totalQuestions) * 100) : 0;

    // كلمات تشجيعية
    let feedback = "";
    if (score >= 90) feedback = "ممتاز! أحسنت، استمر على هذا النحو 🌟";
    else if (score >= 75) feedback = "جيد جدًا! أداء رائع 👏";
    else if (score >= 60) feedback = "جيد، يمكنك التحسن أكثر 💪";
    else feedback = "لا بأس، راجع الدروس وحاول مرة أخرى ❤️";

    // توصيات
    let recommendations = "";
    if (score < 60) {
        recommendations = "ننصحك بمراجعة القواعد النحوية والبلاغية، وحل المزيد من الأسئلة.";
    } else if (score < 80) {
        recommendations = "أداء جيد، ركّز على أنواع الأسئلة التي أخطأت فيها.";
    } else {
        recommendations = "أداء ممتاز! استمر في التقدم وجرّب امتحانات أصعب.";
    }

    // بناء النتائج التفصيلية
    let detailedResults = '';
    let questionNumber = 0; // رقم السؤال الحقيقي (للأسئلة القابلة للتصحيح فقط)

    examData.questions.forEach(q => {
        const userAnswer = userAnswers[q.id];
        let answerText = 'لم تُجب';
        let statusText = 'لم تُجب ❌';

        // عرض الفقرات والشعر
        if (q.type === "passage") {
            detailedResults += `
                <div class="result-item">
                    <h4>📖 فقرة نصية</h4>
                    <div class="passage">${q.content.replace(/\n/g, '<br>')}</div>
                </div>
            `;
            return;
        }

        if (q.type === "poem") {
            detailedResults += `
                <div class="result-item">
                    <h4>📜 نص شعري</h4>
                    <div class="poem">${q.content.replace(/\n/g, '<br>')}</div>
                </div>
            `;
            return;
        }

        // زيادة رقم السؤال فقط للأسئلة القابلة للتصحيح (اختيار من متعدد)
        if (q.type === "multiple-choice") {
            questionNumber++;
        }

        // معالجة الإجابة
        if (q.type === "multiple-choice") {
            const selectedOption = q.options.find(opt => opt.id == userAnswer?.selected);
            answerText = selectedOption ? selectedOption.text : 'لم تُجب';
            
            if (userAnswer && selectedOption?.correct) {
                statusText = 'إجابة صحيحة ✅';
            } else if (userAnswer && !selectedOption?.correct) {
                statusText = 'إجابة خاطئة ❌';
            } else {
                statusText = 'لم تُجب ❌';
            }
        } 
        else if (q.type === "fill-in-blank") {
            // السؤال المقالي: يظهر لكن بدون تأثير على العد
            answerText = userAnswer?.answer?.trim() || 'لم تُجب';
            statusText = (userAnswer && answerText !== 'لم تُجب') ? 'تمت الإجابة (تحت المراجعة)' : 'لم تُجب ❌';
        }

        // عرض السؤال بالشكل المطلوب
        detailedResults += `
            <div class="result-item">
                ${q.type === "multiple-choice" ? `<p><strong>السؤال ${questionNumber}: ${q.text}</strong></p>` : `<p><strong>${q.text}</strong></p>`}
                <p><strong>إجابتك:</strong> ${answerText}</p>
                <p><strong>الحالة:</strong> ${statusText}</p>
                <p><strong>📌 التفسير الكامل:</strong> ${q.explanation}</p>
            </div>
        `;
    });

    // عرض النتيجة النهائية
    document.getElementById('score').innerHTML = `
        <div class="stats">الإجابات الصحيحة: ${correctCount} من ${totalQuestions}</div>
        <div class="stats">النسبة المئوية: ${score}%</div>
        <div class="feedback">${feedback}</div>
        <div class="recommendations"><strong>توصية:</strong> ${recommendations}</div>
    `;

    document.getElementById('detailed-results').innerHTML = detailedResults;

    // إخفاء الأسئلة وإظهار النتائج
    document.getElementById('questions-container').style.display = 'none';
    document.querySelector('.navigation').style.display = 'none';
    document.querySelector('.controls').style.display = 'flex';
    document.getElementById('results-container').style.display = 'block';
}
    // طباعة النتائج
    function printResults() {
        window.print();
    }

    // مشاركة النتائج
    function shareResults() {
        if (navigator.share) {
            navigator.share({
                title: 'نتيجة الامتحان',
                text: `حصلت على ${document.getElementById('score').textContent} في امتحان اللغة العربية`,
                url: window.location.href
            })
            .catch(error => {
                console.log('Error sharing:', error);
                alert('لم يتمكن المتصفح من مشاركة النتائج. يرجى المحاولة لاحقًا.');
            });
        } else {
            alert('مشاركة النتائج غير مدعومة في هذا المتصفح. يمكنك استخدام زر الطباعة بدلاً من ذلك.');
        }
    }

    // إعادة بدء الامتحان
    function restartExam() {
        if (confirm('هل تريد إعادة بدء الامتحان؟ سيتم حذف جميع إجاباتك الحالية.')) {
            userAnswers = {};
            answered = {};
            currentQuestionIndex = 0;
            localStorage.removeItem(`exam_${examId}`);
            location.reload();
        }
    }

    // العودة إلى قائمة الامتحانات
    function backToExams() {
        if (confirm('هل تريد العودة إلى قائمة الامتحانات؟ سيتم فقدان تقدمك الحالي إذا لم تحفظه.')) {
            window.location.href = '/questions.html'; // تغيير هذا الرابط حسب الصفحة المناسبة
        }
    }

    // تهيئة الامتحان
    function initExam() {
        const container = document.getElementById('questions-container');
        const totalQuestions = examData.questions.filter(q => q.type !== "passage" && q.type !== "poem").length;
        document.getElementById('total-questions').textContent = totalQuestions;
        document.getElementById('current-question').textContent = getQuestionNumber(currentQuestionIndex);

        // تحميل الحالة
        const wasResumed = loadSavedData();

        // إنشاء الأسئلة
        examData.questions.forEach((q, index) => {
            const questionEl = document.createElement('div');
            questionEl.className = 'question';
            questionEl.id = `question-${q.id}`;
            questionEl.style.display = index === currentQuestionIndex ? 'block' : 'none';

            if (q.type === "passage") {
                questionEl.innerHTML = `<div class="passage">${q.content.replace(/\n/g, '<br>')}</div>`;
                // تمييز أسئلة النص كأسئلة تمت الإجابة عليها تلقائيًا
                answered[index] = false;
            } else if (q.type === "poem") {
                questionEl.innerHTML = `<div class="poem">${q.content.replace(/\n/g, '<br>')}</div>`;
                // تمييز أسئلة الشعر كأسئلة تمت الإجابة عليها تلقائيًا
                answered[index] = false;
            } else {
                let content = `<h3>السؤال ${getQuestionNumber(index)}: ${q.text}</h3>`;

                if (q.type === "multiple-choice") {
                    let optionsHtml = '<div class="options">';
                    q.options.forEach(opt => {
                        const selected = userAnswers[q.id]?.selected == opt.id;
                        const isAnswered = userAnswers[q.id];
                        const correct = opt.correct;
                        optionsHtml += `
                            <div class="option ${selected ? 'selected' : ''} ${isAnswered && correct ? 'correct' : ''} ${isAnswered && !correct && selected ? 'incorrect' : ''}"
                                 data-question="${q.id}" data-option="${opt.id}" data-correct="${opt.correct}"
                                 onclick="selectOption(this, ${q.id}, ${opt.id}, ${opt.correct})">
                                ${opt.text}
                            </div>
                        `;
                    });
                    optionsHtml += '</div>';
                    content += optionsHtml;
                } else if (q.type === "fill-in-blank") {
                    const value = userAnswers[q.id]?.answer || '';
                    content += `
                        <div class="fill-in-blank">
                            <input type="text" id="fill-${q.id}" value="${value}" placeholder="أدخل إجابتك هنا" oninput="onFillInput(${q.id})">
                        </div>
                    `;
                }

                content += `<div class="explanation" id="explanation-${q.id}" style="${userAnswers[q.id] ? 'display:block' : 'display:none'}">
                    <strong>التفسير:</strong> ${q.explanation}
                </div>`;
                questionEl.innerHTML = content;
                
                // تحديد ما إذا كان السؤال قد تمت الإجابة عليه
                answered[index] = !!userAnswers[q.id];
            }

            container.appendChild(questionEl);
        });

        // تحديث زر التالي بناءً على السؤال الحالي
        updateNextButton();

        // ربط الأحداث
        document.getElementById('next-btn').addEventListener('click', nextQuestion);
        document.getElementById('prev-btn').addEventListener('click', prevQuestion);
        document.getElementById('print-btn').addEventListener('click', printResults);
        document.getElementById('share-btn').addEventListener('click', shareResults);
        document.getElementById('restart-btn').addEventListener('click', restartExam);
        document.getElementById('back-btn').addEventListener('click', backToExams);

        if (wasResumed) {
            alert(`تم استئناف الامتحان من السؤال ${getQuestionNumber(currentQuestionIndex)}`);
        }
    }

    // بدء الامتحان عند تحميل الصفحة
    window.onload = initExam;
</script>
</body>
</html>